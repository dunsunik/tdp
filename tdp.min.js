/*
TDP - Tiny Dialogue Plugin
Alexej Sidorenko, 2k16
https://github.com/fra-iesus/tdp
*/
!function(a){var b=function(b,c,d){function f(a){return a.split(" ")[0]}function g(a,b){var c=a.split(" ");return c[0]+='[name="'+b+'"]',c.join(" ")}function h(a,b){var c;return c=a.is(":visible")?a.offset().top:a.parent().offset().top,b=null===b?c:Math.min(b,c)}function j(b,c){function d(b,c){var d=b.indexOf("."),e=b.indexOf("#"),f="";if(d>0||e>0){var g;g=d>0&&e>0?Math.min(d,e):d>0?d:e,f=b.substring(g),b=b.substring(0,g)}var h=f.split("."),i=a("<"+b+"></"+b+">"),j="",k="";return a.each(h,function(a,b){b.indexOf("#")>=0?j+=b.replace(/^#/,""):k+=b+" "}),j.length&&i.attr("id",j),k.length&&i.attr("class",k.trim()),a(i).html(c)}var e=b.split(" ");e=e.reverse();var f=c;return a.each(e,function(a,b){f=d(b,f).prop("outerHTML")}),a(f)}var e=this;if(this._defaults={animationSpeed:"slow",animationFastSpeed:"fast",errorMessageEmptyInput:"Field is mandatory",scrollToErrorDuration:2e3,scrollToErrorEnabled:!0,dialogShowDuration:500,dialogCloseDuration:500,dialogAutoclose:!1,validationOkElement:"span.tdp-vld-ok",validationOkText:"âœ“",prevalidation:!0,notEmptyAsValidated:!0,validationOkShow:function(a){return a.fadeIn(e.options("animationSpeed"))},validationOkHide:function(a){return a.fadeOut(e.options("animationFastSpeed"))},validationWorkingElement:"span.tdp-vld-working",validationWorkingShow:function(a){return a.fadeIn(e.options("animationSpeed"))},validationWorkingHide:function(a){return a.fadeOut(e.options("animationFastSpeed"))},validationMessageElement:"span.tdp-vld-msg",validationMessageSeparator:"<br />",validationMessageProcessor:function(a){return a.join(e.options("validationMessageSeparator"))},validationMessageFlashDelay:300,validationMessageFlash:function(a){return a.fadeIn(e.options("animationSpeed")).fadeOut(e.options("animationSpeed")).fadeIn(e.options("animationSpeed")).fadeOut(e.options("animationSpeed")).fadeIn(e.options("animationSpeed"))},validationMessageShow:function(a){return a.fadeIn(e.options("animationSpeed"))},validationMessageHide:function(a){return a.fadeOut(e.options("animationFastSpeed"))},validatorRequestProcessor:function(a,b){return{data:a,params:b}},validatorResponseProcessor:function(a){return!!a&&a.response},submitMethod:null,submitTimeout:5e3,submitUrl:null,submitLoadingElement:null,beforeSubmit:null,submitElement:'input[type="submit"]',submitHandlers:{success:function(a){},error:function(a){},always:function(){e.options("submitLoadingElement")&&a(e.options("submitLoadingElement")).hide()}},skipOnInput:["validator","min","not","match"],verbose:!1,logger:null},!d||"object"!=typeof d){if(!c||"object"!=typeof c)return console.warn("$.TdpPlugin constructor called without mandatory parameters");d=c,c={}}if(c&&"object"==typeof c||(c={}),this._options=a.extend(!0,{},this._defaults,c),this._parameters=a.extend(!0,{},d),this._parameters.element=b,this.validators_to_go=0,this.after_validators=null,this.options=function(b){return b?"string"==typeof b?this._options[b]:a.extend(!0,this._options,b):this._options},this.options("logger")&&a(this.options("logger")).length?this._log=a(this.options("logger")):this._log=null,this.show=function(){return a(this._parameters.element).show(this.options("dialogShowDuration")),this},this.hide=function(){return a(this._parameters.element).hide(this.options("dialogCloseDuration")),this},this.getInput=function(b){if(!this._parameters.values[b])return console.warn('Unknown input "'+b+'"'),"";var c="radio"===this._parameters.values[b].type?":checked":"",d=a(this._parameters.element).find('input[name="'+b+'"]'+c+',textarea[name="'+b+'"],select[name="'+b+'"]').first();return d.length?d:""!==c&&(d=a(this._parameters.element).find('input[name="'+b+'"],textarea[name="'+b+'"],select[name="'+b+'"]').first(),d.length)?d:(console.warn('Element for input "'+b+'" does not exist'),"")},this.getValue=function(a){if("hidden"===this._parameters.values[a].type)return this._parameters.values[a].value;var b=this.getInput(a);return b&&("radio"!==b.attr("type")&&"checkbox"!==b.attr("type")||b.prop("checked"))?b.val():""},this.setValue=function(b,c){var d=this.getInput(b);if(!d.length)return console.warn('Element for input "'+b+'" does not exist'),!1;if("radio"===d.attr("type")||"checkbox"===d.attr("type")){if(!c)return a(this._parameters.element).find('input[name="'+b+'"]').first().prop("checked",!1);a(this._parameters.element).find('input[name="'+b+'"]').filter('[value="'+c+'"]').first().prop("checked",!0)}return this.getInput(b).val(c)},this.showValidationMsg=function(b,c){this._parameters.values[b].validation_element&&(b=this._parameters.values[b].validation_element);var d=a(this._parameters.element).find(f(this.options("validationMessageElement"))+'[name="'+b+'"]').first();if(d){if(c){var e=a(this._parameters.element).find(g(this.options("validationMessageElement"),b)).first();e.html(c)}this.options("validationMessageShow")(d)}},this.hideValidationMsg=function(b){this._parameters.values[b].validation_element&&(b=this._parameters.values[b].validation_element);var c=a(this._parameters.element).find(f(this.options("validationMessageElement"))+'[name="'+b+'"]').first();if(c){this.options("validationMessageHide")(c);var d=a(this._parameters.element).find(g(this.options("validationMessageElement"),b)).first();d.html("")}},this.showValidationOk=function(b){var c=a(this._parameters.element).find(f(this.options("validationOkElement"))+'[name="'+b+'"]').first();c&&this.options("validationOkShow")(c)},this.hideValidationOk=function(b){var c=a(this._parameters.element).find(f(this.options("validationOkElement"))+'[name="'+b+'"]').first();c&&this.options("validationOkHide")(c)},this.showValidationWorking=function(b){var c=a(this._parameters.element).find(g(this.options("validationWorkingElement"),b)).first();c&&this.options("validationWorkingShow")(c)},this.hideValidationWorking=function(b){var c=a(this._parameters.element).find(g(this.options("validationWorkingElement"),b)).first();c&&this.options("validationWorkingHide")(c)},this.reset=function(){var a=this;Object.keys(this._parameters.values).forEach(function(b){var c=a._parameters.values[b];"hidden"!==c.type&&(c.validated=null,c.partial_error=!1,c.old_value=null,c.in_progress=!1,a.setValue(b,c.value),a.hideValidationMsg(b),a.hideValidationOk(b),c.value&&a.options("prevalidation")&&a.validate(b))}),a.after_validators=null,a.validators_to_go=0},this.validate=function(b,c,d){if("string"==typeof b&&"hidden"===this._parameters.values[b].type)return this._parameters.values[b].validated=!0,!0;var e=b instanceof jQuery?b:"string"==typeof b?this.getInput(b):a(b);if(e&&e.is("input,textarea,select")){var f=this,g=e.attr("name");if(g in f._parameters.values){var i=f._parameters.values[g],j=f.getValue(g);if("string"==typeof j&&(j=j.trim(),"tel"===i.type&&(j=j.replace(/[ -]/g,""))),null!==i.old_value&&j===i.old_value&&!i.match&&!i.revalidate)return i.validated;c?i.old_value=null:i.old_value=j,i.matches&&(i.validated=null,i.matches.some(function(a){null!==f._parameters.values[a].validated&&f.validate(a,c,d)}));var k=[],l=!1,m=!1;if(c&&(m=!0),"number"==typeof j&&isNaN(j)||void 0===j||null==j||""===j){if(f.hideValidationOk(g),i.empty&&!i.revalidate)return f.hideValidationMsg(g),i.validated=!0,!0;if(!i.empty)return f.showValidationMsg(g,f.options("errorMessageEmptyInput")),i.validated=!1,!1}if(!i.conditions||!i.conditions.length)return i.validated=!0,f.hideValidationMsg(g),f.options("notEmptyAsValidated")&&f.showValidationOk(g),!0;i.partial_error=!1,i.conditions.some(function(b){if(c&&a.inArray(b.type,c)>-1)return!1;var o,p,n=!0;switch(i.type){case"tel":case"email":case"password":case"text":o=j.length,p=b.value;break;case"date":o=new Date(j),p=new Date(b.value);break;case"integer":o=parseInt(j,10),o!=j&&(o=null),p=b.value;break;case"float":o=parseFloat(j,10),o!=j&&(o=null),p=b.value;break;case"checkbox":case"radio":case"select":o=j,p=b.value;break;case"hidden":break;default:console.warn('Input "'+g+'" has unknown input type "'+i.type+'"')}switch(null!==f._log&&f._log.append("Evaluating condition '"+b.type+"("+o+", "+p+")'\n"),b.type){case"regular":var q=new RegExp(b.value);n=q.test(j);break;case"not":n=o!==p;break;case"notNaN":n=!("number"==typeof o&&isNaN(o))&&void 0!==o;break;case"valid":n=o==j;break;case"min":n=!("number"==typeof o&&isNaN(o))&&void 0!==o&&o>=p;break;case"max":n=!("number"==typeof o&&isNaN(o))&&void 0!==o&&o<=p;break;case"match":n=j==f.getValue(b.value);break;case"date":case"age":var s,t,u,r=!1;if(a.isArray(b.value)?(s=f.getValue(b.value[0]),t=f.getValue(b.value[1]),u=f.getValue(b.value[2]),s&&t&&u?date=new Date(s,t-1,u):(d?i.empty?(i.validated=!0,n=!0):(m=!0,n=!1):(n=!0,i.empty?i.validated=!0:m=!0),r=!0)):date=new Date(j),!r)if("[object Date]"!==Object.prototype.toString.call(date)||isNaN(date.getTime()))n=!1;else if("age"===b.type){var v=+date;n=~~((Date.now()-v-864e5)/315576e5)>=b.value[3]}else if(date.getFullYear()==s&&date.getMonth()==t-1&&date.getDate()==u){if(n=!0,a.isArray(b.value)){var w=i.validated;i.validated=!0,b.value.some(function(a){g==a||f._parameters.values[a].validated||f.validate(a,c,d)}),i.validated=w}}else n=!1;break;case"validator":if(j==i.value&&i.prevalidated)n=!0;else if(!i.in_progress){f.hideValidationMsg(g),f.hideValidationOk(g),f.showValidationWorking(g),l=!0,i.validated=!1,f.validators_to_go++,i.in_progress=!0;a.ajax({url:b.value,type:"POST",data:JSON.stringify(f.options("validatorRequestProcessor")(j,b.params)),dataType:"json",timeout:f.options("submitTimeout"),cache:!1,success:function(c){var d=f.options("validatorResponseProcessor")(c),j=!1;j="string"==typeof d?f.options("validationMessageProcessor")([d]):!!d&&b.message,j||i.partial_error?(i.validated=!1,"string"==typeof j&&f.showValidationMsg(g,j),f.hideValidationOk(g),f.validators_to_go--,f.first_unvalidated=h(e.parent().children("label").length?e.parent().children("label").first():e,f.first_unvalidated),f.after_validators=null,f.validators_to_go||f.options("scrollToErrorEnabled")&&f.first_unvalidated&&a("html, body").animate({scrollTop:f.first_unvalidated},f.options("scrollToErrorDuration"))):(i.validated=!0,f.showValidationOk(g),f.validators_to_go--,0===f.validators_to_go&&null!==f.after_validators&&(f.after_validators(),f.after_validators=null))},error:function(c){i.validated=!1,f.validators_to_go--,f.first_unvalidated=h(e.parent().children("label").length?e.parent().children("label").first():e,f.first_unvalidated),f.after_validators=null,n=f.options("validationMessageProcessor")([b.message]),f.showValidationMsg(g,n),f.hideValidationOk(g),f.validators_to_go||f.options("scrollToErrorEnabled")&&f.first_unvalidated&&a("html, body").animate({scrollTop:f.first_unvalidated},f.options("scrollToErrorDuration"))},async:!0}).always(function(){i.in_progress=!1,f.hideValidationWorking(g)})}break;default:console.warn('Unknown condition type "'+b.type+'"')}return!(n||(l||(i.partial_error=!0),k.push(b.message),!b.last))}),m||l?m&&(i.validated=!1):i.validated=0===k.length;var n=f.options("validationMessageProcessor")(k);return n?(f.showValidationMsg(g,n),f.hideValidationOk(g)):(f.hideValidationMsg(g),m||l||i.match&&!f._parameters.values[i.match].validated?f.hideValidationOk(g):f.showValidationOk(g)),!n}console.warn('Input "'+g+'" is not defined for validation')}else console.warn('Element "'+b+'" is not valid input')},Object.keys(this._parameters.values).forEach(function(c){var d=e._parameters.values[c];d.validated||(d.validated=null),d.old_value=null;var f=!1,h=!1,i=null,k=null;if(d.conditions&&d.conditions.length&&d.conditions.some(function(b){return"match"===b.type?(f=b.value,e._parameters.values[f].matches||(e._parameters.values[f].matches=[]),e._parameters.values[f].matches.push(c),void(h=!0)):"date"===b.type||"age"===b.type?(h=!0,void(a.isArray(b.value)&&b.value[0]!=c&&(d.validation_element=b.value[0]))):void("min"===b.type?i=b.value:"max"===b.type&&(k=b.value))}),d.match=f,d.revalidate=h,"hidden"!==d.type){if(input_element=b.find('input[name="'+c+'"],textarea[name="'+c+'"],select[name="'+c+'"]'),"select"===d.type&&(d.interval||d.values)&&(d.values&&d.values.some(function(a){var b=[];b="string"==typeof a||"number"==typeof a?[a,a,!1]:[a[0],a.length>1?a[1]:a[0],a.length>2&&!a[2]];var c=j("option",a[1]).attr("value",a[0]);a[2]&&c.attr("disabled"),d.value==b[1]&&c.attr("selected"),input_element.append(c)}),d.interval)){var l=d.interval[0],m=d.interval[1],n=l<m?1:-1;d.interval.length>2&&(n*=d.interval[2]);var o;for(o=l;o*n<=m*n;o+=n){var p=j("option",o).attr("value",o);d.value==o&&p.attr("selected"),input_element.append(p)}}"radio"===d.type?(d.value&&e.setValue(c,d.value),input_element.on("click",function(){return e.validate(c),!0})):((i||k)&&("number"===input_element.attr("type")&&(i&&input_element.attr("min",i),k&&input_element.attr("max",k)),"text"!==input_element.attr("type")&&"tel"!==input_element.attr("type")||k&&input_element.attr("maxlength",("text"===d.type?k:k.toString().length)+1)),d.value&&e.setValue(c,d.value),"select"===d.type?(input_element.on("input",function(){e.validate(c)}),input_element.on("change",function(){setTimeout(function(){e.validate(c)},100)})):(input_element.on("input",function(){e.validate(c,e.options("skipOnInput"))}),input_element.on("change, blur",function(){setTimeout(function(){e.validate(c)},100)}))),input_element.is("textarea")||input_element.keypress(function(b){if(13==b.which)return a(b.currentTarget).length&&e.validate(a(b.currentTarget).attr("name")),e.submitForm(),!1}),input_element.on("change.autofill DOMAttrModified.autofill keydown.autofill propertychange.autofill",function(a){setTimeout(function(){""!==input_element.val()&&input_element.trigger("input")},0)});var q=input_element;"radio"===d.type&&(q=b.find('input[name="'+c+'"]').last(),q.length&&q.next('label[for="'+q.attr("id")+'"]').length&&(q=q.next('label[for="'+q.attr("id")+'"]'))),!q.length||b.find(g(e.options("validationMessageElement"),c)).length||b.find(g(e.options("validationOkElement"),c)).length||q.after(j(e.options("validationMessageElement"),"").attr("name",c).hide()).after(j(e.options("validationOkElement"),e.options("validationOkText")).attr("name",c).hide());var r=!1;d.conditions&&d.conditions.length&&d.conditions.some(function(a){if("validator"===a.type)return void(r=!0)}),r&&q.length&&!b.find(g(e.options("validationWorkingElement"),c)).length&&q.after(j(e.options("validationWorkingElement"),"").attr("name",c).hide()),e.hideValidationOk(c),e.hideValidationMsg(c),e.hideValidationWorking(c),d.value&&e.options("prevalidation")&&e.validate(c)}}),this.revalidateAll=function(b,c){var d=!0,e=0,g=this;return g.first_unvalidated=null,Object.keys(g._parameters.values).forEach(function(i){var j=g._parameters.values[i];if("hidden"!==j.type&&(!j.validated||j.revalidate)){var k=g.getInput(i);if(k.parent().is(":visible"))if(j.in_progress)d=!1;else{var l=g.validators_to_go;b&&null!==j.validated&&!j.revalidate||j.in_progress||g.validate(i,c,!0),j.validated===!1&&(d=!1,g.validators_to_go===l&&(g.after_validators=null,g.first_unvalidated=h(k.parent().children("label").length?k.parent().children("label").first():k,g.first_unvalidated),setTimeout(function(){g.options("validationMessageFlash")(a(f(g.options("validationMessageElement"))+'[name="'+i+'"]').first())},g.options("validationMessageFlashDelay")*e++)))}}}),!!d||(g.first_unvalidated&&g.options("scrollToErrorEnabled")&&(g.validators_to_go||a("html, body").animate({scrollTop:g.first_unvalidated},g.options("scrollToErrorDuration"))),!1)},this.ajaxSubmit=function(){var b=this,c={},d=!1;if(Object.keys(b._parameters.values).forEach(function(a){var e,f=!1;"hidden"===b._parameters.values[a].type?(e=b._parameters.values[a].value,f=!0,b._parameters.alwaysSubmit&&(d=!0)):!b._parameters.values[a].match&&b.getInput(a).parent().is(":visible")&&(e=b.getValue(a),"string"==typeof e&&(e=e.trim(),"tel"===b._parameters.values[a].type&&(e=e.replace(/[ -]/g,""))),f=!!b._parameters.alwaysSubmit||e!=b._parameters.values[a].value&&(null!=e&&""!=e||null!=b._parameters.values[a].value&&""!=b._parameters.values[a].value),f&&(d=!0)),f&&(b._parameters.values[a].prefix?(b._parameters.values[a].prefix in c||(c[b._parameters.values[a].prefix]={}),c[b._parameters.values[a].prefix][a]=e):c[a]=e)}),!d)return void(b._parameters.displayElement&&(a(b._parameters.element).hide(b.options("animationFastSpeed")),b._parameters.editLink&&a(b._parameters.editLink).show()));b.options("beforeSubmit")&&b.options("beforeSubmit")(b),b.options("submitLoadingElement")&&a(b.options("submitLoadingElement")).show();a.ajax({url:b.options("submitUrl"),type:"POST",data:JSON.stringify(c),dataType:"json",timeout:b.options("submitTimeout"),cache:!1,success:function(d){(b._parameters.displayElement||b._parameters.editLink)&&(a(b._parameters.element).hide(b.options("animationFastSpeed")),b._parameters.editLink&&a(b._parameters.editLink).show()),"function"==typeof b.options("submitHandlers").success&&b.options("submitHandlers").success(d,b,c)},error:function(a){"function"==typeof b.options("submitHandlers").error&&b.options("submitHandlers").error(a,b,c)},async:!0}).always(function(){"function"==typeof b.options("submitHandlers").always&&b.options("submitHandlers").always(b,c)})},this.submitForm=function(a){return e.after_validators=function(){return null!==e.options("submitMethod")?e.options("submitMethod")(e):e.ajaxSubmit()},null!==a&&"object"==typeof a&&(a.preventDefault(),a.stopPropagation()),!!e.revalidateAll(!1)&&(null!==e.options("submitMethod")?e.options("submitMethod")(e):e.ajaxSubmit())},b.is("form")||b.find("form").length){var k=b.is("form")?b:b.find("form").first();k.bind("submit",function(a){return e.submitForm(a),!1})}b.find(this.options("submitElement")).on("click",function(a){return e.submitForm(a),!1})};a.fn.tdp=function(c){function i(){var b=a(this),c=b.data("TdpPlugin");g.push(c)}function j(a){var b=g[a];if(!b)return console.warn("$.TdpPlugin not instantiated yet"),console.info(this),void h.push(void 0);if("function"==typeof b[d]){var c=b[d].apply(b,e);h.push(c)}else console.warn("Method '"+d+"' not defined in $.TdpPlugin")}function k(){var c=a(this),d=new b(c,f,e);c.data("TdpPlugin",d)}var f,d="string"==typeof c?c:void 0,e=arguments.length>1?Array.prototype.slice.call(arguments,1)[0]:void 0,g=[],h=[];return d?(this.each(i),this.each(j),h.length>1?h:h[0]):(f="object"==typeof c?c:void 0,this.each(k))}}(jQuery);
