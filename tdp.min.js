/*
TDP - Tiny Dialogue Plugin
Alexej Sidorenko, 2k16
https://github.com/fra-iesus/tdp
*/
!function(e){var t=function(t,a,n){function i(e){return e.split(" ")[0]}function o(e,t){var a=e.split(" ");return a[0]+='[name="'+t+'"]',a.join(" ")}function s(e){var a=t.find('input[name="'+e+'"],textarea[name="'+e+'"],select[name="'+e+'"]').first();return a.length?a:null}function l(t){var a=t instanceof jQuery?t:"string"==typeof t?s(t):e(t);return a?a.is(":radio")?a.filter(":checked").val():a.val():null}function r(t,a){function n(t,a){var n=t.indexOf("."),i=t.indexOf("#"),o="";if(n>0||i>0){var s;s=n>0&&i>0?Math.min(n,i):n>0?n:i,o=t.substring(s),t=t.substring(0,s)}var l=o.split("."),r=e("<"+t+"></"+t+">"),d="",u="";return e.each(l,function(e,t){t.indexOf("#")>=0?d+=t.replace(/^#/,""):u+=t+" "}),d.length&&r.attr("id",d),u.length&&r.attr("class",u.trim()),e(r).html(a)}var i=t.split(" ");i=i.reverse();var o=a;return e.each(i,function(e,t){o=n(t,o).prop("outerHTML")}),e(o)}var d=this;if(this._defaults={scrollToErrorDuration:2e3,dialogShowDuration:500,dialogCloseDuration:500,dialogAutoclose:!1,validationOkElement:"span.tdp-vld-ok",validationOkText:"âœ“",prevalidation:!0,validationOkShow:function(e){return e.fadeIn("slow")},validationOkHide:function(e){return e.fadeOut("fast")},validationWorkingElement:"span.tdp-vld-working",validationWorkingShow:function(e){return e.fadeIn("slow")},validationWorkingHide:function(e){return e.fadeOut("fast")},validationMessageElement:"span.tdp-vld-msg",validationMessageSeparator:"<br />",validationMessageProcessor:function(e){return e.join(d.options("validationMessageSeparator"))},validationMessageFlashDelay:300,validationMessageFlash:function(e){return e.fadeIn("slow").fadeOut("slow").fadeIn("slow").fadeOut("slow").fadeIn("slow")},validationMessageShow:function(e){return e.fadeIn("slow")},validationMessageHide:function(e){return e.fadeOut("fast")},validatorRequestProcessor:function(e,t){return{data:e,params:t}},validatorResponseProcessor:function(e){return e?e.response:!1},submitMethod:null,submitElement:'input[type="submit"]',verbose:!1,logger:null},this._options=e.extend(!0,{},this._defaults,a),this._parameters=n,this.options=function(t){return t?"string"==typeof t?this._options[t]:e.extend(!0,this._options,t):this._options},!n||"object"!=typeof n){if(!a||"object"!=typeof a)return console.log("$.TdpPlugin constructor called without mandatory parameters");n=a,a={}}a&&"object"==typeof a||(a={}),this.options("logger")&&e(this.options("logger")).length?this._log=e(this.options("logger")):this._log=null,this.show=function(){return t.show(this.options("dialogShowDuration")),t},this.hide=function(){return t.hide(this.options("dialogCloseDuration")),t},this.validate=function(t,a){var n=t instanceof jQuery?t:"string"==typeof t?s(t):e(t);if(n.is("input,textarea,select")){var r=this,d=n.attr("name");if(d in this._parameters.values){var u=l(n),v=e(o(r.options("validationMessageElement"),d)).first(),p=e(i(r.options("validationMessageElement"))+'[name="'+d+'"]').first(),c=e(i(r.options("validationOkElement"))+'[name="'+d+'"]').first(),f=this._parameters.values[d];if(u===f.old_value)if(f.match){if(l(f.match)==u)return}else if(!f.revalidate)return;a||(f.old_value=u);var h=[],m=!1,g=!1;if(a&&(g=!0),!f.conditions||!f.conditions.length)return f.validated=!0,!0;f.conditions.some(function(t){if(a&&e.inArray(t.type,a)>-1)return!1;var n,i,s=!0;switch(f.type){case"tel":case"email":case"password":case"text":n=u.length,i=t.value;break;case"date":n=new Date(u),i=new Date(t.value);break;case"integer":n=parseInt(u,10),i=t.value;break;case"float":n=parseFloat(u,10),i=t.value;break;case"checkbox":case"radio":case"select":n=u,i=t.value;break;case"hidden":break;default:console.warn('Input "'+d+'" has unknown input type "'+f.type+'"')}switch(null!==r._log&&r._log.append("Evaluating condition '"+t.type+"("+n+", "+i+")'\n"),t.type){case"regular":var k=new RegExp(t.value);s=k.test(u);break;case"not":s=n!==i;break;case"notNaN":s=!Number.isNaN(n)&&void 0!==n;break;case"valid":s=n==u;break;case"min":s=!Number.isNaN(n)&&void 0!==n&&n>=i;break;case"max":s=!Number.isNaN(n)&&void 0!==n&&i>=n;break;case"match":s=u==l(t.value);break;case"date":case"age":var y,b=!1;if(e.isArray(t.value)?l(t.value[0])&&l(t.value[1])&&l(t.value[2])?y=new Date(l(t.value[0]),l(t.value[1])-1,l(t.value[2])):b=!0:y=new Date(u),b)g=!0,s=!0;else if("[object Date]"!==Object.prototype.toString.call(y)||isNaN(y.getTime()))s=!1;else if("age"===t.type){var w=+y;s=~~((Date.now()-w-864e5)/315576e5)>=t.value[3]}else if(y.getFullYear()==l(t.value[0])&&y.getMonth()==l(t.value[1])-1&&y.getDate()==l(t.value[2])){if(s=!0,e.isArray(t.value)){var M=f.validated;f.validated=1,t.value.some(function(e){d==e||r._parameters.values[e].validated||r.validate(e,a)}),f.validated=M}}else s=!1;break;case"validator":r.options("validationMessageHide")(p),r.options("validationOkHide")(c);var _=e(o(r.options("validationWorkingElement"),d)).first();r.options("validationWorkingShow")(_),m=!0;e.ajax({url:t.value,type:"POST",data:r.options("validatorRequestProcessor")(u,t.params),dataType:"json",timeout:5e3,cache:!1,success:function(e){var a=r.options("validatorResponseProcessor")(e),n=!1;n="string"==typeof a?r.options("validationMessageProcessor")([a]):a?t.message:!1,n?(f.validated=0,v.html(n),r.options("validationMessageShow")(p)):(f.validated=1,r.options("validationOkShow")(c))},error:function(e){f.validated=0,s=r.options("validationMessageProcessor")([t.message]),v.html(s),r.options("validationMessageShow")(p)},async:!0}).always(function(){r.options("validationWorkingHide")(_)});break;default:console.warn('Unknown condition type "'+t.type+'"')}return!s&&(h.push(t.message),t.last)?!0:!1}),g||(f.validated=0===h.length);var k=this.options("validationMessageProcessor")(h);return k?(v.html(k),this.options("validationMessageShow")(p),this.options("validationOkHide")(c)):(this.options("validationMessageHide")(p),g||m||f.match&&!this._parameters.values[f.match].validated||this.options("validationOkShow")(c)),!k}console.warn('Input "'+d+'" is not defined for validation')}else console.warn('Element "'+t+'" is not valid input')},Object.keys(this._parameters.values).forEach(function(a){var n=d._parameters.values[a];n.validated=null,n.old_value=null;var s=!1,l=!1;n.conditions&&n.conditions.length&&n.conditions.some(function(e){return"match"===e.type?(s=e.value,void(l=!0)):"date"===e.type?void(l=!0):void 0}),n.match=s,n.revalidate=l,t.find('input[name="'+a+'"],textarea[name="'+a+'"],select[name="'+a+'"]').each(function(){if(input_element=e(this),"select"===n.type&&(n.interval||n.values)&&(input_element.find("option").remove(),n.values&&n.values.some(function(e){var t=[];t="string"==typeof e?[e,e,!1]:[e[0],e.length>1?e[1]:e[0],e.length>2?!e[2]:!1];var a=r("option",e[1]).attr("value",e[0]);e[2]&&a.attr("disabled"),input_element.append(a)}),n.interval)){var s=n.interval[0],l=n.interval[1],u=l>s?1:-1;n.interval.length>2&&(u*=n.interval[2]);var v;for(v=s;l*u>=v*u;v+=u)input_element.append(r("option",v).attr("value",v))}"radio"===n.type?(n.value&&input_element.filter("[value="+n.value+"]").prop("checked",!0),input_element.on("click",function(){d.validate(this)})):(n.value&&input_element.val(n.value),input_element.on("input",function(){d.validate(this,["validator","min","not","match"])}),input_element.on("change, blur",function(){d.validate(this)}));var p=input_element;"radio"===n.type&&(p=t.find('input[name="'+a+'"],textarea[name="'+a+'"],select[name="'+a+'"]').last(),p.next('label[for="'+p.attr("id")+'"]').length&&(p=p.next('label[for="'+p.attr("id")+'"]'))),e(o(d.options("validationMessageElement"),a)).length||e(o(d.options("validationOkElement"),a)).length?(d.options("validationMessageHide")(e(i(d.options("validationMessageElement"))+'[name="'+a+'"]').first()),d.options("validationOkHide")(e(i(d.options("validationOkElement"))+'[name="'+a+'"]').first())):p.after(r(d.options("validationMessageElement"),"").attr("name",a).hide()).after(r(d.options("validationOkElement"),d.options("validationOkText")).attr("name",a).hide());var c=!1;n.conditions&&n.conditions.length&&n.conditions.some(function(e){return"validator"===e.type?void(c=!0):void 0}),c&&(e(o(d.options("validationWorkingElement"),a)).length?d.options("validationWorkingHide")(e(i(d.options("validationWorkingElement"))+'[name="'+a+'"]').first()):p.after(r(d.options("validationWorkingElement"),"").attr("name",a).hide())),n.value&&d.options("prevalidation")&&d.validate(this)})}),this.submitForm=function(t){var a=null,n=0;return Object.keys(d._parameters.values).forEach(function(t){var o=d._parameters.values[t];if(!o.validated||o.revalidate){var l=s(t);(null===o.validated||o.revalidate)&&d.validate(l),a=null===a?l.offset().top:Math.min(a,l.offset().top),o.validated||null===o.validated||setTimeout(function(){d.options("validationMessageFlash")(e(i(d.options("validationMessageElement"))+'[name="'+t+'"]').first())},d.options("validationMessageFlashDelay")*n++)}}),a?(e("html, body").animate({scrollTop:a},d.options("scrollToErrorDuration")),null!==t&&"object"==typeof t&&t.preventDefault(),!1):null!==d.options("submitMethod")?(null!==t&&"object"==typeof t&&t.preventDefault(),d.options("submitMethod")()):!0},t.is("form")&&t.submit(function(e){return d.submitForm()?!0:(e.preventDefault(),!1)}),t.find(this.options("submitElement")).on("click",function(e){return e.preventDefault(),d.submitForm()?!0:!1})};e.fn.tdp=function(a){function n(){var t=e(this),a=t.data("TdpPlugin");d.push(a)}function i(e){var t=d[e];if(!t)return console.warn("$.TdpPlugin not instantiated yet"),console.info(this),void u.push(void 0);if("function"==typeof t[l]){var a=t[l].apply(t,r);u.push(a)}else console.warn("Method '"+l+"' not defined in $.TdpPlugin")}function o(){var a=e(this),n=new t(a,s,r);a.data("TdpPlugin",n)}var s,l="string"==typeof a?a:void 0,r=arguments.length>1?Array.prototype.slice.call(arguments,1)[0]:void 0,d=[],u=[];return l?(this.each(n),this.each(i),u.length>1?u:u[0]):(s="object"==typeof a?a:void 0,this.each(o))}}(jQuery);
