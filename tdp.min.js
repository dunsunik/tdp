/*
TDP - Tiny Dialogue Plugin
Alexej Sidorenko, 2k16
https://github.com/fra-iesus/tdp
*/
!function(t){var e=function(e,a,n){function i(e,a){var n=e.indexOf("."),i=e.indexOf("#"),o="";if(n>0||i>0){var s;s=n>0&&i>0?Math.min(n,i):n>0?n:i,o=e.substring(s),e=e.substring(0,s)}var l=o.split("."),r=t("<"+e+"></"+e+">"),d="",u="";return t.each(l,function(t,e){e.indexOf("#")>=0?d+=e.replace(/^#/,""):u+=e+" "}),d.length&&r.attr("id",d),u.length&&r.attr("class",u.trim()),t(r).html(a)}function o(t){var a=e.find('input[name="'+t+'"],textarea[name="'+t+'"],select[name="'+t+'"]').first();return a.length?a.val():void 0}var s=this;if(this._defaults={scrollToErrorDuration:2e3,dialogShowDuration:500,dialogCloseDuration:500,dialogAutoclose:!1,validationOkElement:"span.tdp-vld-ok",validationOkShow:function(t){return t.fadeIn("slow")},validationOkHide:function(t){return t.fadeOut("fast")},validationWorkingElement:"span.tdp-vld-working",validationWorkingShow:function(t){return t.fadeIn("slow")},validationWorkingHide:function(t){return t.fadeOut("fast")},validationMessageElement:"span.tdp-vld-msg",validationMessageSeparator:"<br />",validationMessageProcessor:function(t){return t.join(s.options("validationMessageSeparator"))},validationMessageFlashDelay:300,validationMessageFlash:function(t){return t.fadeIn("slow").fadeOut("slow").fadeIn("slow").fadeOut("slow").fadeIn("slow")},validationMessageShow:function(t){return t.fadeIn("slow")},validationMessageHide:function(t){return t.fadeOut("fast")},validatorRequestProcessor:function(t,e){return{data:t,params:e}},validatorResponseProcessor:function(t){return t?t.response:!1},submitMethod:null,verbose:!1,logger:null},this.options=function(e){return e?"string"==typeof e?this._options[e]:t.extend(!0,this._options,e):this._options},!n||"object"!=typeof n){if(!a||"object"!=typeof a)return console.log("$.TdpPlugin constructor called without mandatory parameters");n=a,a={}}a&&"object"==typeof a||(a={}),this._options=t.extend(!0,{},this._defaults,a),this._parameters=n,Object.keys(this._parameters.values).forEach(function(a){var n=s._parameters.values[a];n.validated=null,n.old_value=null;var o=!1;n.conditions.some(function(t){return"match"===t.type?void(o=t.value):void 0}),n.match=o,e.find('input[name="'+a+'"],textarea[name="'+a+'"],select[name="'+a+'"]').each(function(){input_element=t(this),"select"===n.type&&n.values&&(e.find("option").remove(),n.values.some(function(t){var e=[];e="string"==typeof t?[t,t,!1]:[t[0],t.length>1?t[1]:t[0],t.length>2?!t[2]:!1];var a=i("option",t[1]).attr("value",t[0]);t[2]&&a.attr("disabled"),input_element.append(a)})),t(s.options("validationMessageElement")+'[name="'+a+'"]').length||t(s.options("validationOkElement")+'[name="'+a+'"]').length||input_element.after(i(s.options("validationMessageElement"),"").attr("name",a).hide()).after(i(s.options("validationOkElement"),"âœ“").attr("name",a).hide()),input_element.val(n.value),s.options("validationMessageHide")(t(s.options("validationMessageElement")+'[name="'+a+'"]').first()),s.options("validationOkHide")(t(s.options("validationOkElement")+'[name="'+a+'"]').first()),input_element.on("input",function(){s.validate(this,["validator","min","not","match"])}),input_element.on("change, blur",function(){s.validate(this)})})}),this.options("logger")&&t(this.options("logger")).length?this._log=t(this.options("logger")):this._log=null,e.submit(function(a){var n=null,i=0;return Object.keys(s._parameters.values).forEach(function(a){var o=s._parameters.values[a];if(!o.validated||o.match){var l=e.find('input[name="'+a+'"],textarea[name="'+a+'"],select[name="'+a+'"]').first();(null===o.validated||o.match)&&s.validate(l),n||(n=l),o.validated||setTimeout(function(){s.options("validationMessageFlash")(t(s.options("validationMessageElement")+'[name="'+a+'"]').first())},s.options("validationMessageFlashDelay")*i++)}}),n?(t("html, body").animate({scrollTop:n.offset().top},s.options("scrollToErrorDuration")),!1):null!==s.options("submitMethod")?(a.preventDefault(),s.options("submitMethod")()):!0}),this.show=function(){return e.show(this.options("dialogShowDuration")),e},this.hide=function(){return e.hide(this.options("dialogCloseDuration")),e},this.validate=function(e,a){var n=e instanceof jQuery?e:t(e),i=this;if(n.is("input,textarea,select")){var s=this,l=n.attr("name");if(l in this._parameters.values){var r=n.val(),d=t(i.options("validationMessageElement")+'[name="'+l+'"]').first(),u=t(i.options("validationOkElement")+'[name="'+l+'"]').first(),v=this._parameters.values[l];if(r===v.old_value){if(!v.match)return;if(o(this._parameters.values[v.match])==r)return}a||(v.old_value=r);var p=[],c=!1;if(!v.conditions||!v.conditions.length)return v.validated=!0,!0;v.conditions.some(function(e){if(a&&t.inArray(e.type,a)>-1)return!1;var n,h,f=!0;switch(v.type){case"tel":case"email":case"password":case"text":n=r.length,h=e.value;break;case"date":n=new Date(r),h=new Date(e.value);break;case"integer":n=parseInt(r,10),h=e.value;break;case"float":n=parseFloat(r,10),h=e.value;break;case"checkbox":case"radio":case"select":n=r,h=e.value;break;case"hidden":break;default:console.warn('Input "'+l+'" has unknown input type "'+v.type+'"')}switch(null!==s._log&&s._log.append("Evaluating condition '"+e.type+"("+n+", "+h+")'\n"),e.type){case"regular":var m=new RegExp(e.value);f=m.test(r);break;case"not":f=n!==h;break;case"notNaN":f=!Number.isNaN(n);break;case"valid":f=n==r;break;case"min":f=!Number.isNaN(n)&&n>=h;break;case"max":f=!Number.isNaN(n)&&h>=n;break;case"match":f=r==o(e.value);break;case"validator":i.options("validationWorkingShow")(t(i.options("validationWorkingElement")+'[name="'+l+'"]').first()),c=!0;t.ajax({url:e.value,type:"POST",data:i.options("validatorRequestProcessor")(r,e.params),dataType:"json",timeout:5e3,cache:!1,success:function(t){var a=i.options("validatorResponseProcessor")(t),n=!1;"string"==typeof a?(v.validated=0,n=i.options("validationMessageProcessor")([a])):(v.validated=!a,n=a?e.message:!1),n?(d.html(n),i.options("validationMessageShow")(d),i.options("validationOkHide")(u)):(i.options("validationMessageHide")(d),i.options("validationOkShow")(u))},error:function(t){v.validated=0,f=i.options("validationMessageProcessor")([e.message]),d.html(f),i.options("validationMessageShow")(d),i.options("validationOkHide")(u)},async:!0}).always(function(){i.options("validationWorkingHide")(t(i.options("validationWorkingElement")+'[name="'+l+'"]').first())});break;default:console.warn('Unknown condition type "'+e.type+'"')}return!f&&(p.push(e.message),e.last)?!0:!1}),v.validated=0===p.length;var h=this.options("validationMessageProcessor")(p);return h?(d.html(h),this.options("validationMessageShow")(d),this.options("validationOkHide")(u)):(this.options("validationMessageHide")(d),a||c||v.match&&!this._parameters.values[v.match].validated||this.options("validationOkShow")(u)),v.validated}console.warn('Input "'+l+'" is not defined for validation')}else console.warn('Element "'+e+'" is not valid input')}};t.fn.tdp=function(a){function n(){var e=t(this),a=e.data("TdpPlugin");d.push(a)}function i(t){var e=d[t];if(!e)return console.warn("$.TdpPlugin not instantiated yet"),console.info(this),void u.push(void 0);if("function"==typeof e[l]){var a=e[l].apply(e,r);u.push(a)}else console.warn("Method '"+l+"' not defined in $.TdpPlugin")}function o(){var a=t(this),n=new e(a,s,r);a.data("TdpPlugin",n)}var s,l="string"==typeof a?a:void 0,r=arguments.length>1?Array.prototype.slice.call(arguments,1)[0]:void 0,d=[],u=[];return l?(this.each(n),this.each(i),u.length>1?u:u[0]):(s="object"==typeof a?a:void 0,this.each(o))}}(jQuery);
