/*
TDP - Tiny Dialogue Plugin
Alexej Sidorenko, 2k16
https://github.com/fra-iesus/tdp
*/
!function(e){var t=function(t,a,i){function n(e){return e.split(" ")[0]}function o(e,t){var a=e.split(" ");return a[0]+='[name="'+t+'"]',a.join(" ")}function s(e,t){var a;return a=e.is(":visible")?e.offset().top:e.parent().offset().top,t=null===t?a:Math.min(t,a)}function r(t,a){function i(t,a){var i=t.indexOf("."),n=t.indexOf("#"),o="";if(i>0||n>0){var s;s=i>0&&n>0?Math.min(i,n):i>0?i:n,o=t.substring(s),t=t.substring(0,s)}var r=o.split("."),l=e("<"+t+"></"+t+">"),d="",u="";return e.each(r,function(e,t){t.indexOf("#")>=0?d+=t.replace(/^#/,""):u+=t+" "}),d.length&&l.attr("id",d),u.length&&l.attr("class",u.trim()),e(l).html(a)}var n=t.split(" ");n=n.reverse();var o=a;return e.each(n,function(e,t){o=i(t,o).prop("outerHTML")}),e(o)}var l=this;if(this._defaults={animationSpeed:"slow",animationFastSpeed:"fast",errorMessageEmptyInput:"Field is mandatory",scrollToErrorDuration:2e3,scrollToErrorEnabled:!0,dialogShowDuration:500,dialogCloseDuration:500,dialogAutoclose:!1,validationOkElement:"span.tdp-vld-ok",validationOkText:"âœ“",prevalidation:!0,notEmptyAsValidated:!0,validationOkShow:function(e){return e.fadeIn(l.options("animationSpeed"))},validationOkHide:function(e){return e.fadeOut(l.options("animationFastSpeed"))},validationWorkingElement:"span.tdp-vld-working",validationWorkingShow:function(e){return e.fadeIn(l.options("animationSpeed"))},validationWorkingHide:function(e){return e.fadeOut(l.options("animationFastSpeed"))},validationMessageElement:"span.tdp-vld-msg",validationMessageSeparator:"<br />",validationMessageProcessor:function(e){return e.join(l.options("validationMessageSeparator"))},validationMessageFlashDelay:300,validationMessageFlash:function(e){return e.fadeIn(l.options("animationSpeed")).fadeOut(l.options("animationSpeed")).fadeIn(l.options("animationSpeed")).fadeOut(l.options("animationSpeed")).fadeIn(l.options("animationSpeed"))},validationMessageShow:function(e){return e.fadeIn(l.options("animationSpeed"))},validationMessageHide:function(e){return e.fadeOut(l.options("animationFastSpeed"))},validatorRequestProcessor:function(e,t){return{data:e,params:t}},validatorResponseProcessor:function(e){return e?e.response:!1},submitMethod:null,submitTimeout:5e3,submitUrl:null,submitLoadingElement:null,beforeSubmit:null,submitElement:'input[type="submit"]',submitHandlers:{success:function(e){},error:function(e){},always:function(){l.options("submitLoadingElement")&&e(l.options("submitLoadingElement")).hide()}},skipOnInput:["validator","min","not","match"],verbose:!1,logger:null},!i||"object"!=typeof i){if(!a||"object"!=typeof a)return console.warn("$.TdpPlugin constructor called without mandatory parameters");i=a,a={}}if(a&&"object"==typeof a||(a={}),this._options=e.extend(!0,{},this._defaults,a),this._parameters=e.extend(!0,{},i),this._parameters.element=t,this.validators_to_go=0,this.after_validators=null,this.options=function(t){return t?"string"==typeof t?this._options[t]:e.extend(!0,this._options,t):this._options},this.options("logger")&&e(this.options("logger")).length?this._log=e(this.options("logger")):this._log=null,this.show=function(){return e(this._parameters.element).show(this.options("dialogShowDuration")),this},this.hide=function(){return e(this._parameters.element).hide(this.options("dialogCloseDuration")),this},this.getInput=function(t){if(!this._parameters.values[t])return console.warn('Unknown input "'+t+'"'),"";var a="radio"===this._parameters.values[t].type?":checked":"",i=e(this._parameters.element).find('input[name="'+t+'"]'+a+',textarea[name="'+t+'"],select[name="'+t+'"]').first();return i.length?i:""!==a&&(i=e(this._parameters.element).find('input[name="'+t+'"],textarea[name="'+t+'"],select[name="'+t+'"]').first(),i.length)?i:(console.warn('Element for input "'+t+'" does not exist'),"")},this.getValue=function(e){if("hidden"===this._parameters.values[e].type)return this._parameters.values[e].value;var t=this.getInput(e);return t&&("radio"!==t.attr("type")&&"checkbox"!==t.attr("type")||t.prop("checked"))?t.val():""},this.setValue=function(t,a){var i=this.getInput(t);if(!i.length)return console.warn('Element for input "'+t+'" does not exist'),!1;if("radio"===i.attr("type")||"checkbox"===i.attr("type")){if(!a)return e(this._parameters.element).find('input[name="'+t+'"]').first().prop("checked",!1);e(this._parameters.element).find('input[name="'+t+'"]').filter('[value="'+a+'"]').first().prop("checked",!0)}return this.getInput(t).val(a)},this.showValidationMsg=function(t,a){this._parameters.values[t].validation_element&&(t=this._parameters.values[t].validation_element);var i=e(this._parameters.element).find(n(this.options("validationMessageElement"))+'[name="'+t+'"]').first();if(i){if(a){var s=e(this._parameters.element).find(o(this.options("validationMessageElement"),t)).first();s.html(a)}this.options("validationMessageShow")(i)}},this.hideValidationMsg=function(t){this._parameters.values[t].validation_element&&(t=this._parameters.values[t].validation_element);var a=e(this._parameters.element).find(n(this.options("validationMessageElement"))+'[name="'+t+'"]').first();if(a){this.options("validationMessageHide")(a);var i=e(this._parameters.element).find(o(this.options("validationMessageElement"),t)).first();i.html("")}},this.showValidationOk=function(t){var a=e(this._parameters.element).find(n(this.options("validationOkElement"))+'[name="'+t+'"]').first();a&&this.options("validationOkShow")(a)},this.hideValidationOk=function(t){var a=e(this._parameters.element).find(n(this.options("validationOkElement"))+'[name="'+t+'"]').first();a&&this.options("validationOkHide")(a)},this.showValidationWorking=function(t){var a=e(this._parameters.element).find(o(this.options("validationWorkingElement"),t)).first();a&&this.options("validationWorkingShow")(a)},this.hideValidationWorking=function(t){var a=e(this._parameters.element).find(o(this.options("validationWorkingElement"),t)).first();a&&this.options("validationWorkingHide")(a)},this.reset=function(){var e=this;Object.keys(this._parameters.values).forEach(function(t){var a=e._parameters.values[t];"hidden"!==a.type&&(a.validated=null,a.partial_error=!1,a.old_value=null,a.in_progress=!1,e.setValue(t,a.value),e.hideValidationMsg(t),e.hideValidationOk(t),a.value&&e.options("prevalidation")&&e.validate(t))}),e.after_validators=null,e.validators_to_go=0},this.validate=function(t,a){if("string"==typeof t&&"hidden"===this._parameters.values[t].type)return this._parameters.values[t].validated=!0,!0;var i=t instanceof jQuery?t:"string"==typeof t?this.getInput(t):e(t);if(i&&i.is("input,textarea,select")){var n=this,o=i.attr("name");if(o in n._parameters.values){var r=n._parameters.values[o],l=n.getValue(o);if("string"==typeof l&&(l=l.trim(),"tel"===r.type&&(l=l.replace(/[ -]/g,""))),null!==r.old_value&&l===r.old_value&&!r.match&&!r.revalidate)return;a?r.old_value=null:r.old_value=l,r.matches&&r.matches.some(function(e){null!==n._parameters.values[e].validated&&n.validate(e)});var d=[],u=!1,p=!1;if(a&&(p=!0),"number"==typeof l&&isNaN(l)||void 0===l||null==l||""===l){if(n.hideValidationOk(o),r.empty&&!r.revalidate)return n.hideValidationMsg(o),r.validated=!0,!0;if(!r.empty)return n.showValidationMsg(o,n.options("errorMessageEmptyInput")),r.validated=!1,!1}if(!r.conditions||!r.conditions.length)return r.validated=!0,n.hideValidationMsg(o),n.options("notEmptyAsValidated")&&n.showValidationOk(o),!0;r.partial_error=!1,r.conditions.some(function(t){if(a&&e.inArray(t.type,a)>-1)return!1;var v,m,f=!0;switch(r.type){case"tel":case"email":case"password":case"text":v=l.length,m=t.value;break;case"date":v=new Date(l),m=new Date(t.value);break;case"integer":v=parseInt(l,10),m=t.value;break;case"float":v=parseFloat(l,10),m=t.value;break;case"checkbox":case"radio":case"select":v=l,m=t.value;break;case"hidden":break;default:console.warn('Input "'+o+'" has unknown input type "'+r.type+'"')}switch(null!==n._log&&n._log.append("Evaluating condition '"+t.type+"("+v+", "+m+")'\n"),t.type){case"regular":var h=new RegExp(t.value);f=h.test(l);break;case"not":f=v!==m;break;case"notNaN":f=!("number"==typeof v&&isNaN(v))&&void 0!==v;break;case"valid":f=v==l;break;case"min":f=!("number"==typeof v&&isNaN(v))&&void 0!==v&&v>=m;break;case"max":f=!("number"==typeof v&&isNaN(v))&&void 0!==v&&m>=v;break;case"match":f=l==n.getValue(t.value);break;case"date":case"age":var c,g,_,y,b=!1;if(e.isArray(t.value)?(g=n.getValue(t.value[0]),_=n.getValue(t.value[1]),y=n.getValue(t.value[2]),g||_||y?c=new Date(g,_-1,y):b=!0):c=new Date(l),b)p=!0,f=!0;else if("[object Date]"!==Object.prototype.toString.call(c)||isNaN(c.getTime()))f=!1;else if("age"===t.type){var k=+c;f=~~((Date.now()-k-864e5)/315576e5)>=t.value[3]}else if(c.getFullYear()==g&&c.getMonth()==_-1&&c.getDate()==y){if(f=!0,e.isArray(t.value)){var w=r.validated;r.validated=1,t.value.some(function(e){o==e||n._parameters.values[e].validated||n.validate(e,a)}),r.validated=w}}else f=!1;break;case"validator":if(l==r.value&&r.prevalidated)f=!0;else if(!r.in_progress){n.hideValidationMsg(o),n.hideValidationOk(o),n.showValidationWorking(o),u=!0,r.validated=!1,n.validators_to_go++,r.in_progress=!0;e.ajax({url:t.value,type:"POST",data:JSON.stringify(n.options("validatorRequestProcessor")(l,t.params)),dataType:"json",timeout:n.options("submitTimeout"),cache:!1,success:function(a){var l=n.options("validatorResponseProcessor")(a),d=!1;d="string"==typeof l?n.options("validationMessageProcessor")([l]):l?t.message:!1,d||r.partial_error?(r.validated=!1,"string"==typeof d&&n.showValidationMsg(o,d),n.hideValidationOk(o),n.validators_to_go--,n.first_unvalidated=s(i.parent().children("label").length?i.parent().children("label").first():i,n.first_unvalidated),n.after_validators=null,n.validators_to_go||n.options("scrollToErrorEnabled")&&n.first_unvalidated&&e("html, body").animate({scrollTop:n.first_unvalidated},n.options("scrollToErrorDuration"))):(r.validated=!0,n.showValidationOk(o),n.validators_to_go--,0===n.validators_to_go&&null!==n.after_validators&&(n.after_validators(),n.after_validators=null))},error:function(a){r.validated=!1,n.validators_to_go--,n.first_unvalidated=s(i.parent().children("label").length?i.parent().children("label").first():i,n.first_unvalidated),n.after_validators=null,f=n.options("validationMessageProcessor")([t.message]),n.showValidationMsg(o,f),n.hideValidationOk(o),n.validators_to_go||n.options("scrollToErrorEnabled")&&n.first_unvalidated&&e("html, body").animate({scrollTop:n.first_unvalidated},n.options("scrollToErrorDuration"))},async:!0}).always(function(){r.in_progress=!1,n.hideValidationWorking(o)})}break;default:console.warn('Unknown condition type "'+t.type+'"')}return!f&&(u||(r.partial_error=!0),d.push(t.message),t.last)?!0:!1}),p||u?p&&(r.validated=0):r.validated=0===d.length;var v=n.options("validationMessageProcessor")(d);return v?(n.showValidationMsg(o,v),n.hideValidationOk(o)):(n.hideValidationMsg(o),p||u||r.match&&!n._parameters.values[r.match].validated?n.hideValidationOk(o):n.showValidationOk(o)),!v}console.warn('Input "'+o+'" is not defined for validation')}else console.warn('Element "'+t+'" is not valid input')},Object.keys(this._parameters.values).forEach(function(a){var i=l._parameters.values[a];i.validated||(i.validated=null),i.old_value=null;var n=!1,s=!1;if(i.conditions&&i.conditions.length&&i.conditions.some(function(t){return"match"===t.type?(n=t.value,l._parameters.values[n].matches||(l._parameters.values[n].matches=[]),l._parameters.values[n].matches.push(a),void(s=!0)):"date"===t.type?void(s=!0):void("age"===t.type&&e.isArray(t.value)&&t.value[0]!=a&&(i.validation_element=t.value[0]))}),i.match=n,i.revalidate=s,"hidden"!==i.type){if(input_element=t.find('input[name="'+a+'"],textarea[name="'+a+'"],select[name="'+a+'"]'),"select"===i.type&&(i.interval||i.values)&&(i.values&&i.values.some(function(e){var t=[];t="string"==typeof e||"number"==typeof e?[e,e,!1]:[e[0],e.length>1?e[1]:e[0],e.length>2?!e[2]:!1];var a=r("option",e[1]).attr("value",e[0]);e[2]&&a.attr("disabled"),i.value==t[1]&&a.attr("selected"),input_element.append(a)}),i.interval)){var d=i.interval[0],u=i.interval[1],p=u>d?1:-1;i.interval.length>2&&(p*=i.interval[2]);var v;for(v=d;u*p>=v*p;v+=p){var m=r("option",v).attr("value",v);i.value==v&&m.attr("selected"),input_element.append(m)}}"radio"===i.type?(i.value&&l.setValue(a,i.value),input_element.on("click",function(){return l.validate(a),!0})):(i.value&&l.setValue(a,i.value),"select"===i.type?input_element.on("input",function(){l.validate(a)}):input_element.on("input",function(){l.validate(a,l.options("skipOnInput"))}),input_element.on("change, blur",function(){setTimeout(function(){l.validate(a)},100)})),input_element.is("textarea")||input_element.keypress(function(t){return 13==t.which?(e(t.currentTarget).length&&l.validate(e(t.currentTarget).attr("name")),l.submitForm(),!1):void 0}),input_element.on("change.autofill DOMAttrModified.autofill keydown.autofill propertychange.autofill",function(e){setTimeout(function(){""!==input_element.val()&&input_element.trigger("input")},0)});var f=input_element;"radio"===i.type&&(f=t.find('input[name="'+a+'"]').last(),f.length&&f.next('label[for="'+f.attr("id")+'"]').length&&(f=f.next('label[for="'+f.attr("id")+'"]'))),!f.length||t.find(o(l.options("validationMessageElement"),a)).length||t.find(o(l.options("validationOkElement"),a)).length||f.after(r(l.options("validationMessageElement"),"").attr("name",a).hide()).after(r(l.options("validationOkElement"),l.options("validationOkText")).attr("name",a).hide());var h=!1;i.conditions&&i.conditions.length&&i.conditions.some(function(e){return"validator"===e.type?void(h=!0):void 0}),h&&f.length&&!t.find(o(l.options("validationWorkingElement"),a)).length&&f.after(r(l.options("validationWorkingElement"),"").attr("name",a).hide()),l.hideValidationOk(a),l.hideValidationMsg(a),l.hideValidationWorking(a),i.value&&l.options("prevalidation")&&l.validate(a)}}),this.revalidateAll=function(t,a){var i=!0,o=0,r=this;return r.first_unvalidated=null,Object.keys(r._parameters.values).forEach(function(l){var d=r._parameters.values[l];if("hidden"!==d.type&&(!d.validated||d.revalidate)){var u=r.getInput(l);if(u.parent().is(":visible"))if(d.in_progress)i=!1;else{var p=r.validators_to_go;t&&null!==d.validated&&!d.revalidate||d.in_progress||r.validate(l,a),d.validated===!1&&(i=!1,r.validators_to_go===p&&(r.after_validators=null,r.first_unvalidated=s(u.parent().children("label").length?u.parent().children("label").first():u,r.first_unvalidated),setTimeout(function(){r.options("validationMessageFlash")(e(n(r.options("validationMessageElement"))+'[name="'+l+'"]').first())},r.options("validationMessageFlashDelay")*o++)))}}}),i?!0:(r.first_unvalidated&&r.options("scrollToErrorEnabled")&&(r.validators_to_go||e("html, body").animate({scrollTop:r.first_unvalidated},r.options("scrollToErrorDuration"))),!1)},this.ajaxSubmit=function(){var t=this,a={},i=!1;if(Object.keys(t._parameters.values).forEach(function(e){var n,o=!1;"hidden"===t._parameters.values[e].type?(n=t._parameters.values[e].value,o=!0,t._parameters.alwaysSubmit&&(i=!0)):!t._parameters.values[e].match&&t.getInput(e).parent().is(":visible")&&(n=t.getValue(e),"string"==typeof n&&(n=n.trim(),"tel"===t._parameters.values[e].type&&(n=n.replace(/[ -]/g,""))),o=t._parameters.alwaysSubmit?!0:n!=t._parameters.values[e].value&&(null!=n&&""!=n||null!=t._parameters.values[e].value&&""!=t._parameters.values[e].value),o&&(i=!0)),o&&(t._parameters.values[e].prefix?(t._parameters.values[e].prefix in a||(a[t._parameters.values[e].prefix]={}),a[t._parameters.values[e].prefix][e]=n):a[e]=n)}),!i)return void(t._parameters.displayElement&&(e(t._parameters.element).hide(t.options("animationFastSpeed")),t._parameters.editLink&&e(t._parameters.editLink).show()));t.options("beforeSubmit")&&t.options("beforeSubmit")(t),t.options("submitLoadingElement")&&e(t.options("submitLoadingElement")).show();e.ajax({url:t.options("submitUrl"),type:"POST",data:JSON.stringify(a),dataType:"json",timeout:t.options("submitTimeout"),cache:!1,success:function(i){(t._parameters.displayElement||t._parameters.editLink)&&(e(t._parameters.element).hide(t.options("animationFastSpeed")),t._parameters.editLink&&e(t._parameters.editLink).show()),"function"==typeof t.options("submitHandlers").success&&t.options("submitHandlers").success(i,t,a)},error:function(e){"function"==typeof t.options("submitHandlers").error&&t.options("submitHandlers").error(e,t,a)},async:!0}).always(function(){"function"==typeof t.options("submitHandlers").always&&t.options("submitHandlers").always(t,a)})},this.submitForm=function(e){return l.after_validators=function(){return null!==l.options("submitMethod")?l.options("submitMethod")(l):l.ajaxSubmit()},null!==e&&"object"==typeof e&&e.preventDefault(),l.revalidateAll(!0)?null!==l.options("submitMethod")?l.options("submitMethod")(l):l.ajaxSubmit():!1},t.is("form")||t.find("form").length){var d=t.is("form")?t:t.find("form").first();d.bind("submit",function(e){return l.submitForm(e),!1})}t.find(this.options("submitElement")).on("click",function(e){return l.submitForm(e),!1})};e.fn.tdp=function(a){function i(){var t=e(this),a=t.data("TdpPlugin");d.push(a)}function n(e){var t=d[e];if(!t)return console.warn("$.TdpPlugin not instantiated yet"),console.info(this),void u.push(void 0);if("function"==typeof t[r]){var a=t[r].apply(t,l);u.push(a)}else console.warn("Method '"+r+"' not defined in $.TdpPlugin")}function o(){var a=e(this),i=new t(a,s,l);a.data("TdpPlugin",i)}var s,r="string"==typeof a?a:void 0,l=arguments.length>1?Array.prototype.slice.call(arguments,1)[0]:void 0,d=[],u=[];return r?(this.each(i),this.each(n),u.length>1?u:u[0]):(s="object"==typeof a?a:void 0,this.each(o))}}(jQuery);
