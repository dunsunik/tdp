/*
TDP - Tiny Dialogue Plugin
Alexej Sidorenko, 2k16
https://github.com/fra-iesus/tdp
*/
!function(e){var t=function(t,a,n){function i(t,a){var n=t.indexOf("."),i=t.indexOf("#"),o="";if(n>0||i>0){var s;s=n>0&&i>0?Math.min(n,i):n>0?n:i,o=t.substring(s),t=t.substring(0,s)}var l=o.split("."),r=e("<"+t+"></"+t+">"),d="",u="";return e.each(l,function(e,t){t.indexOf("#")>=0?d+=t.replace(/^#/,""):u+=t+" "}),d.length&&r.attr("id",d),u.length&&r.attr("class",u.trim()),e(r).html(a)}function o(e){var a=t.find('input[name="'+e+'"],textarea[name="'+e+'"],select[name="'+e+'"]').first();return a.length?a.val():void 0}var s=this;if(this._defaults={scrollToErrorDuration:2e3,dialogShowDuration:500,dialogCloseDuration:500,dialogAutoclose:!1,validationOkElement:"span.tdp-vld-ok",validationOkShow:function(e){return e.fadeIn("slow")},validationOkHide:function(e){return e.fadeOut("fast")},validationWorkingElement:"span.tdp-vld-working",validationWorkingShow:function(e){return e.fadeIn("slow")},validationWorkingHide:function(e){return e.fadeOut("fast")},validationMessageElement:"span.tdp-vld-msg",validationMessageSeparator:"<br />",validationMessageProcessor:function(e){return e.join(s.options("validationMessageSeparator"))},validationMessageFlashDelay:300,validationMessageFlash:function(e){return e.fadeIn("slow").fadeOut("slow").fadeIn("slow").fadeOut("slow").fadeIn("slow")},validationMessageShow:function(e){return e.fadeIn("slow")},validationMessageHide:function(e){return e.fadeOut("fast")},validatorRequestProcessor:function(e,t){return{data:e,params:t}},validatorResponseProcessor:function(e){return e?e.response:!1},submitMethod:null,verbose:!1,logger:null},this.options=function(t){return t?"string"==typeof t?this._options[t]:e.extend(!0,this._options,t):this._options},!n||"object"!=typeof n){if(!a||"object"!=typeof a)return console.log("$.TdpPlugin constructor called without mandatory parameters");n=a,a={}}a&&"object"==typeof a||(a={}),this._options=e.extend(!0,{},this._defaults,a),this._parameters=n,Object.keys(this._parameters.values).forEach(function(a){var n=s._parameters.values[a];n.validated=null,n.old_value=null;var o=!1,l=!1;n.conditions&&n.conditions.length&&n.conditions.some(function(e){return"match"===e.type?(o=e.value,void(l=!0)):"date"===e.type?void(l=!0):void 0}),n.match=o,n.revalidate=l,t.find('input[name="'+a+'"],textarea[name="'+a+'"],select[name="'+a+'"]').each(function(){if(input_element=e(this),"select"===n.type&&(n.interval||n.values)&&(input_element.find("option").remove(),n.values&&n.values.some(function(e){var t=[];t="string"==typeof e?[e,e,!1]:[e[0],e.length>1?e[1]:e[0],e.length>2?!e[2]:!1];var a=i("option",e[1]).attr("value",e[0]);e[2]&&a.attr("disabled"),input_element.append(a)}),n.interval)){var t=n.interval[0],o=n.interval[1],l=o>t?1:-1;n.interval.length>2&&(l*=n.interval[2]);var r;for(r=t;o*l>=r*l;r+=l)input_element.append(i("option",r).attr("value",r))}e(s.options("validationMessageElement")+'[name="'+a+'"]').length||e(s.options("validationOkElement")+'[name="'+a+'"]').length?(s.options("validationMessageHide")(e(s.options("validationMessageElement")+'[name="'+a+'"]').first()),s.options("validationOkHide")(e(s.options("validationOkElement")+'[name="'+a+'"]').first())):input_element.after(i(s.options("validationMessageElement"),"").attr("name",a).hide()).after(i(s.options("validationOkElement"),"âœ“").attr("name",a).hide()),e(s.options("validationWorkingElement")+'[name="'+a+'"]').length||input_element.after(i(s.options("validationWorkingElement"),"").attr("name",a).hide()),input_element.val(n.value),input_element.on("input",function(){s.validate(this,["validator","min","not","match","date"])}),input_element.on("change, blur",function(){s.validate(this,["date"])})})}),this.options("logger")&&e(this.options("logger")).length?this._log=e(this.options("logger")):this._log=null,t.submit(function(a){var n=null,i=0;return Object.keys(s._parameters.values).forEach(function(a){var o=s._parameters.values[a];if(!o.validated||o.revalidate){var l=t.find('input[name="'+a+'"],textarea[name="'+a+'"],select[name="'+a+'"]').first();(null===o.validated||o.revalidate)&&s.validate(l),n||(n=l),o.validated||setTimeout(function(){s.options("validationMessageFlash")(e(s.options("validationMessageElement")+'[name="'+a+'"]').first())},s.options("validationMessageFlashDelay")*i++)}}),n?(e("html, body").animate({scrollTop:n.offset().top},s.options("scrollToErrorDuration")),!1):null!==s.options("submitMethod")?(a.preventDefault(),s.options("submitMethod")()):!0}),this.show=function(){return t.show(this.options("dialogShowDuration")),t},this.hide=function(){return t.hide(this.options("dialogCloseDuration")),t},this.validate=function(t,a){var n=t instanceof jQuery?t:e(t),i=this;if(n.is("input,textarea,select")){var s=this,l=n.attr("name");if(l in this._parameters.values){var r=n.val(),d=e(i.options("validationMessageElement")+'[name="'+l+'"]').first(),u=e(i.options("validationOkElement")+'[name="'+l+'"]').first(),v=this._parameters.values[l];if(r===v.old_value)if(v.match){if(o(this._parameters.values[v.match])==r)return}else if(!v.revalidate)return;a||(v.old_value=r);var p=[],c=!1;if(!v.conditions||!v.conditions.length)return v.validated=!0,!0;v.conditions.some(function(t){if(a&&e.inArray(t.type,a)>-1)return!1;var n,h,f=!0;switch(v.type){case"tel":case"email":case"password":case"text":n=r.length,h=t.value;break;case"date":n=new Date(r),h=new Date(t.value);break;case"integer":n=parseInt(r,10),h=t.value;break;case"float":n=parseFloat(r,10),h=t.value;break;case"checkbox":case"radio":case"select":n=r,h=t.value;break;case"hidden":break;default:console.warn('Input "'+l+'" has unknown input type "'+v.type+'"')}switch(null!==s._log&&s._log.append("Evaluating condition '"+t.type+"("+n+", "+h+")'\n"),t.type){case"regular":var m=new RegExp(t.value);f=m.test(r);break;case"not":f=n!==h;break;case"notNaN":f=!Number.isNaN(n);break;case"valid":f=n==r;break;case"min":f=!Number.isNaN(n)&&n>=h;break;case"max":f=!Number.isNaN(n)&&h>=n;break;case"match":f=r==o(t.value);break;case"date":var g;g=e.isArray(t.value)?new Date(o(t.value[0]),o(t.value[1])-1,o(t.value[2])):new Date(r),f="[object Date]"!==Object.prototype.toString.call(g)||isNaN(g.getTime())?!1:g.getFullYear()==o(t.value[0])&&g.getMonth()==o(t.value[1])-1&&g.getDate()==o(t.value[2])?!0:!1;break;case"validator":i.options("validationMessageHide")(d),i.options("validationOkHide")(u),i.options("validationWorkingShow")(e(i.options("validationWorkingElement")+'[name="'+l+'"]').first()),c=!0;e.ajax({url:t.value,type:"POST",data:i.options("validatorRequestProcessor")(r,t.params),dataType:"json",timeout:5e3,cache:!1,success:function(e){var a=i.options("validatorResponseProcessor")(e),n=!1;n="string"==typeof a?i.options("validationMessageProcessor")([a]):a?t.message:!1,n?(v.validated=0,d.html(n),i.options("validationMessageShow")(d)):(v.validated=1,i.options("validationOkShow")(u))},error:function(e){v.validated=0,f=i.options("validationMessageProcessor")([t.message]),d.html(f),i.options("validationMessageShow")(d)},async:!0}).always(function(){i.options("validationWorkingHide")(e(i.options("validationWorkingElement")+'[name="'+l+'"]').first())});break;default:console.warn('Unknown condition type "'+t.type+'"')}return!f&&(p.push(t.message),t.last)?!0:!1}),a||(v.validated=0===p.length);var h=this.options("validationMessageProcessor")(p);return h?(d.html(h),this.options("validationMessageShow")(d),this.options("validationOkHide")(u)):(this.options("validationMessageHide")(d),a||c||v.match&&!this._parameters.values[v.match].validated||this.options("validationOkShow")(u)),!h}console.warn('Input "'+l+'" is not defined for validation')}else console.warn('Element "'+t+'" is not valid input')}};e.fn.tdp=function(a){function n(){var t=e(this),a=t.data("TdpPlugin");d.push(a)}function i(e){var t=d[e];if(!t)return console.warn("$.TdpPlugin not instantiated yet"),console.info(this),void u.push(void 0);if("function"==typeof t[l]){var a=t[l].apply(t,r);u.push(a)}else console.warn("Method '"+l+"' not defined in $.TdpPlugin")}function o(){var a=e(this),n=new t(a,s,r);a.data("TdpPlugin",n)}var s,l="string"==typeof a?a:void 0,r=arguments.length>1?Array.prototype.slice.call(arguments,1)[0]:void 0,d=[],u=[];return l?(this.each(n),this.each(i),u.length>1?u:u[0]):(s="object"==typeof a?a:void 0,this.each(o))}}(jQuery);
