/*
TDP - Tiny Dialogue Plugin
Alexej Sidorenko, 2k16
https://github.com/fra-iesus/tdp
*/
!function(e){var t=function(t,a,i){function n(e){return e.split(" ")[0]}function o(e,t){var a=e.split(" ");return a[0]+='[name="'+t+'"]',a.join(" ")}function s(t,a){function i(t,a){var i=t.indexOf("."),n=t.indexOf("#"),o="";if(i>0||n>0){var s;s=i>0&&n>0?Math.min(i,n):i>0?i:n,o=t.substring(s),t=t.substring(0,s)}var l=o.split("."),r=e("<"+t+"></"+t+">"),d="",u="";return e.each(l,function(e,t){t.indexOf("#")>=0?d+=t.replace(/^#/,""):u+=t+" "}),d.length&&r.attr("id",d),u.length&&r.attr("class",u.trim()),e(r).html(a)}var n=t.split(" ");n=n.reverse();var o=a;return e.each(n,function(e,t){o=i(t,o).prop("outerHTML")}),e(o)}var l=this;if(this._defaults={animationSpeed:"slow",animationFastSpeed:"fast",errorMessageEmptyInput:"Field is mandatory",scrollToErrorDuration:2e3,dialogShowDuration:500,dialogCloseDuration:500,dialogAutoclose:!1,validationOkElement:"span.tdp-vld-ok",validationOkText:"âœ“",prevalidation:!0,notEmptyAsValidated:!0,validationOkShow:function(e){return e.fadeIn(l.options("animationSpeed"))},validationOkHide:function(e){return e.fadeOut(l.options("animationFastSpeed"))},validationWorkingElement:"span.tdp-vld-working",validationWorkingShow:function(e){return e.fadeIn(l.options("animationSpeed"))},validationWorkingHide:function(e){return e.fadeOut(l.options("animationFastSpeed"))},validationMessageElement:"span.tdp-vld-msg",validationMessageSeparator:"<br />",validationMessageProcessor:function(e){return e.join(l.options("validationMessageSeparator"))},validationMessageFlashDelay:300,validationMessageFlash:function(e){return e.fadeIn(l.options("animationSpeed")).fadeOut(l.options("animationSpeed")).fadeIn(l.options("animationSpeed")).fadeOut(l.options("animationSpeed")).fadeIn(l.options("animationSpeed"))},validationMessageShow:function(e){return e.fadeIn(l.options("animationSpeed"))},validationMessageHide:function(e){return e.fadeOut(l.options("animationFastSpeed"))},validatorRequestProcessor:function(e,t){return{data:e,params:t}},validatorResponseProcessor:function(e){return e?e.response:!1},submitMethod:null,submitElement:'input[type="submit"]',verbose:!1,logger:null},this._options=e.extend(!0,{},this._defaults,a),this._parameters=i,this._parameters.element=t,this.options=function(t){return t?"string"==typeof t?this._options[t]:e.extend(!0,this._options,t):this._options},!i||"object"!=typeof i){if(!a||"object"!=typeof a)return console.log("$.TdpPlugin constructor called without mandatory parameters");i=a,a={}}a&&"object"==typeof a||(a={}),this.options("logger")&&e(this.options("logger")).length?this._log=e(this.options("logger")):this._log=null,this.show=function(){return t.show(this.options("dialogShowDuration")),t},this.hide=function(){return t.hide(this.options("dialogCloseDuration")),t},this.getInput=function(e){if(!this._parameters.values[e])return null;var a="radio"===this._parameters.values[e].type?":checked":"",i=t.find('input[name="'+e+'"]'+a+',textarea[name="'+e+'"],select[name="'+e+'"]').first();return i.length?i:null},this.getValue=function(t){var a=t instanceof jQuery?t:"string"==typeof t?this.getInput(t):e(t);return a?a.val():null},this.setValue=function(e,a){return"radio"===this._parameters.values[e].type?a?t.find('input[name="'+e+'"]').filter('[value="'+a+'"]').prop("checked",!0):t.find('input[name="'+e+'"]').prop("checked",!1):("select"===this._parameters.values[e].type&&this.getInput(e).prop("selectedIndex",0),this.getInput(e).val(a))},this.reset=function(){var e=this;Object.keys(this._parameters.values).forEach(function(a){var i=e._parameters.values[a];"hidden"!==i.type&&(i.validated=null,i.old_value=null,e.setValue(a,i.value),e.options("validationMessageHide")(t.find(n(e.options("validationMessageElement"))+'[name="'+a+'"]').first()),e.options("validationOkHide")(t.find(n(e.options("validationOkElement"))+'[name="'+a+'"]').first()),i.value&&e.options("prevalidation")&&e.validate(a))})},this.validate=function(a,i){if("string"==typeof a&&"hidden"===this._parameters.values[a].type)return this._parameters.values[a].validated=!0,!0;var s=a instanceof jQuery?a:"string"==typeof a?this.getInput(a):e(a);if(s.is("input,textarea,select")){var l=this,r=s.attr("name");if(r in l._parameters.values){var d=l.getValue(r),u=t.find(o(l.options("validationMessageElement"),r)).first(),p=t.find(n(l.options("validationMessageElement"))+'[name="'+r+'"]').first(),v=t.find(n(l.options("validationOkElement"))+'[name="'+r+'"]').first(),c=l._parameters.values[r];if(d===c.old_value)if(c.match){if(l.getValue(c.match)==d)return}else if(!c.revalidate)return;i||(c.old_value=d);var f=[],m=!1,h=!1;if(i&&(h=!0),Number.isNaN(d)||void 0===d||null==d||""===d.trim())return l.options("validationOkHide")(v),c.empty?(c.validated=!0,!0):(u.html(l.options("errorMessageEmptyInput")),l.options("validationMessageShow")(p),c.validated=!1,!1);if(!c.conditions||!c.conditions.length)return c.validated=!0,l.options("notEmptyAsValidated")&&l.options("validationOkShow")(v),!0;c.conditions.some(function(t){if(i&&e.inArray(t.type,i)>-1)return!1;var a,n,s=!0;switch(c.type){case"tel":case"email":case"password":case"text":a=d.length,n=t.value;break;case"date":a=new Date(d),n=new Date(t.value);break;case"integer":a=parseInt(d,10),n=t.value;break;case"float":a=parseFloat(d,10),n=t.value;break;case"checkbox":case"radio":case"select":a=d,n=t.value;break;case"hidden":break;default:console.warn('Input "'+r+'" has unknown input type "'+c.type+'"')}switch(null!==l._log&&l._log.append("Evaluating condition '"+t.type+"("+a+", "+n+")'\n"),t.type){case"regular":var g=new RegExp(t.value);s=g.test(d);break;case"not":s=a!==n;break;case"notNaN":s=!Number.isNaN(a)&&void 0!==a;break;case"valid":s=a==d;break;case"min":s=!Number.isNaN(a)&&void 0!==a&&a>=n;break;case"max":s=!Number.isNaN(a)&&void 0!==a&&n>=a;break;case"match":s=d==l.getValue(t.value);break;case"date":case"age":var y,k=!1;if(e.isArray(t.value)?l.getValue(t.value[0])&&l.getValue(t.value[1])&&l.getValue(t.value[2])?y=new Date(l.getValue(t.value[0]),l.getValue(t.value[1])-1,l.getValue(t.value[2])):k=!0:y=new Date(d),k)h=!0,s=!0;else if("[object Date]"!==Object.prototype.toString.call(y)||isNaN(y.getTime()))s=!1;else if("age"===t.type){var b=+y;s=~~((Date.now()-b-864e5)/315576e5)>=t.value[3]}else if(y.getFullYear()==l.getValue(t.value[0])&&y.getMonth()==l.getValue(t.value[1])-1&&y.getDate()==l.getValue(t.value[2])){if(s=!0,e.isArray(t.value)){var _=c.validated;c.validated=1,t.value.some(function(e){r==e||l._parameters.values[e].validated||l.validate(e,i)}),c.validated=_}}else s=!1;break;case"validator":if(d==c.value&&c.prevalidated)s=!0;else{l.options("validationMessageHide")(p),l.options("validationOkHide")(v);var M=e(o(l.options("validationWorkingElement"),r)).first();l.options("validationWorkingShow")(M),m=!0;e.ajax({url:t.value,type:"POST",data:JSON.stringify(l.options("validatorRequestProcessor")(d,t.params)),dataType:"json",timeout:5e3,cache:!1,success:function(e){var a=l.options("validatorResponseProcessor")(e),i=!1;i="string"==typeof a?l.options("validationMessageProcessor")([a]):a?t.message:!1,i?(c.validated=0,u.html(i),l.options("validationMessageShow")(p)):(c.validated=1,l.options("validationOkShow")(v))},error:function(e){c.validated=0,s=l.options("validationMessageProcessor")([t.message]),u.html(s),l.options("validationMessageShow")(p)},async:!0}).always(function(){l.options("validationWorkingHide")(M)})}break;default:console.warn('Unknown condition type "'+t.type+'"')}return!s&&(f.push(t.message),t.last)?!0:!1}),h||(c.validated=0===f.length);var g=l.options("validationMessageProcessor")(f);return g?(u.html(g),l.options("validationMessageShow")(p),l.options("validationOkHide")(v)):(l.options("validationMessageHide")(p),h||m||c.match&&!l._parameters.values[c.match].validated?l.options("validationOkHide")(v):l.options("validationOkShow")(v)),!g}console.warn('Input "'+r+'" is not defined for validation')}else console.warn('Element "'+a+'" is not valid input')},Object.keys(this._parameters.values).forEach(function(a){var i=l._parameters.values[a];i.validated||(i.validated=null),i.old_value=null;var r=!1,d=!1;i.conditions&&i.conditions.length&&i.conditions.some(function(e){return"match"===e.type?(r=e.value,void(d=!0)):"date"===e.type?void(d=!0):void 0}),i.match=r,i.revalidate=d,t.find('input[name="'+a+'"],textarea[name="'+a+'"],select[name="'+a+'"]').each(function(){if(input_element=e(this),"select"===i.type&&(i.interval||i.values)&&(i.values&&i.values.some(function(e){var t=[];t="string"==typeof e?[e,e,!1]:[e[0],e.length>1?e[1]:e[0],e.length>2?!e[2]:!1];var a=s("option",e[1]).attr("value",e[0]);e[2]&&a.attr("disabled"),i.value==t[1]&&a.attr("selected"),input_element.append(a)}),i.interval)){var r=i.interval[0],d=i.interval[1],u=d>r?1:-1;i.interval.length>2&&(u*=i.interval[2]);var p;for(p=r;d*u>=p*u;p+=u)input_element.append(s("option",p).attr("value",p))}"radio"===i.type?(i.value&&input_element.filter('[value="'+i.value+'"]').prop("checked",!0),input_element.on("click",function(){l.validate(this)})):(i.value&&input_element.val(i.value),input_element.on("input",function(){l.validate(this,["validator","min","not","match"])}),input_element.on("change, blur",function(){l.validate(this)}));var v=input_element;"radio"===i.type&&(v=t.find('input[name="'+a+'"]').last(),v.next('label[for="'+v.attr("id")+'"]').length&&(v=v.next('label[for="'+v.attr("id")+'"]'))),t.find(o(l.options("validationMessageElement"),a)).length||t.find(o(l.options("validationOkElement"),a)).length?(l.options("validationMessageHide")(t.find(n(l.options("validationMessageElement"))+'[name="'+a+'"]').first()),l.options("validationOkHide")(t.find(n(l.options("validationOkElement"))+'[name="'+a+'"]').first())):v.after(s(l.options("validationMessageElement"),"").attr("name",a).hide()).after(s(l.options("validationOkElement"),l.options("validationOkText")).attr("name",a).hide());var c=!1;i.conditions&&i.conditions.length&&i.conditions.some(function(e){return"validator"===e.type?void(c=!0):void 0}),c&&(t.find(o(l.options("validationWorkingElement"),a)).length?l.options("validationWorkingHide")(t.find(n(l.options("validationWorkingElement"))+'[name="'+a+'"]').first()):v.after(s(l.options("validationWorkingElement"),"").attr("name",a).hide())),i.value&&l.options("prevalidation")&&l.validate(this)})}),this.revalidateAll=function(t,a){var i=null,o=0,s=this;return Object.keys(s._parameters.values).forEach(function(l){var r=s._parameters.values[l];if(!r.validated||r.revalidate){var d=s.getInput(l);(!t||null===r.validated||r.revalidate)&&s.validate(d,a),r.validated||null===r.validated||(i=null===i?d.offset().top:Math.min(i,d.offset().top),setTimeout(function(){s.options("validationMessageFlash")(e(n(s.options("validationMessageElement"))+'[name="'+l+'"]').first())},s.options("validationMessageFlashDelay")*o++))}}),i?(e("html, body").animate({scrollTop:i},s.options("scrollToErrorDuration")),!1):!0},this.submitForm=function(e){return l.revalidateAll(!0)?null!==l.options("submitMethod")?(null!==e&&"object"==typeof e&&e.preventDefault(),l.options("submitMethod")(l)):!0:(null!==e&&"object"==typeof e&&e.preventDefault(),!1)},t.is("form")&&t.submit(function(e){return l.submitForm(e)?!0:!1}),t.find(this.options("submitElement")).on("click",function(e){return l.submitForm(e)?!0:!1})};e.fn.tdp=function(a){function i(){var t=e(this),a=t.data("TdpPlugin");d.push(a)}function n(e){var t=d[e];if(!t)return console.warn("$.TdpPlugin not instantiated yet"),console.info(this),void u.push(void 0);if("function"==typeof t[l]){var a=t[l].apply(t,r);u.push(a)}else console.warn("Method '"+l+"' not defined in $.TdpPlugin")}function o(){var a=e(this),i=new t(a,s,r);a.data("TdpPlugin",i)}var s,l="string"==typeof a?a:void 0,r=arguments.length>1?Array.prototype.slice.call(arguments,1)[0]:void 0,d=[],u=[];return l?(this.each(i),this.each(n),u.length>1?u:u[0]):(s="object"==typeof a?a:void 0,this.each(o))}}(jQuery);
