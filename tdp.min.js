/*
TDP - Tiny Dialogue Plugin
Alexej Sidorenko, 2k16
https://github.com/fra-iesus/tdp
*/
!function(t){var e=function(e,a,i){function n(t){return t.split(" ")[0]}function o(t,e){var a=t.split(" ");return a[0]+='[name="'+e+'"]',a.join(" ")}function s(e,a){function i(e,a){var i=e.indexOf("."),n=e.indexOf("#"),o="";if(i>0||n>0){var s;s=i>0&&n>0?Math.min(i,n):i>0?i:n,o=e.substring(s),e=e.substring(0,s)}var l=o.split("."),r=t("<"+e+"></"+e+">"),d="",u="";return t.each(l,function(t,e){e.indexOf("#")>=0?d+=e.replace(/^#/,""):u+=e+" "}),d.length&&r.attr("id",d),u.length&&r.attr("class",u.trim()),t(r).html(a)}var n=e.split(" ");n=n.reverse();var o=a;return t.each(n,function(t,e){o=i(e,o).prop("outerHTML")}),t(o)}var l=this;if(this._defaults={animationSpeed:"slow",animationFastSpeed:"fast",errorMessageEmptyInput:"Field is mandatory",scrollToErrorDuration:2e3,dialogShowDuration:500,dialogCloseDuration:500,dialogAutoclose:!1,validationOkElement:"span.tdp-vld-ok",validationOkText:"âœ“",prevalidation:!0,notEmptyAsValidated:!0,validationOkShow:function(t){return t.fadeIn(l.options("animationSpeed"))},validationOkHide:function(t){return t.fadeOut(l.options("animationFastSpeed"))},validationWorkingElement:"span.tdp-vld-working",validationWorkingShow:function(t){return t.fadeIn(l.options("animationSpeed"))},validationWorkingHide:function(t){return t.fadeOut(l.options("animationFastSpeed"))},validationMessageElement:"span.tdp-vld-msg",validationMessageSeparator:"<br />",validationMessageProcessor:function(t){return t.join(l.options("validationMessageSeparator"))},validationMessageFlashDelay:300,validationMessageFlash:function(t){return t.fadeIn(l.options("animationSpeed")).fadeOut(l.options("animationSpeed")).fadeIn(l.options("animationSpeed")).fadeOut(l.options("animationSpeed")).fadeIn(l.options("animationSpeed"))},validationMessageShow:function(t){return t.fadeIn(l.options("animationSpeed"))},validationMessageHide:function(t){return t.fadeOut(l.options("animationFastSpeed"))},validatorRequestProcessor:function(t,e){return{data:t,params:e}},validatorResponseProcessor:function(t){return t?t.response:!1},submitMethod:null,submitElement:'input[type="submit"]',verbose:!1,logger:null},this._options=t.extend(!0,{},this._defaults,a),this._parameters=i,this._parameters.element=e,this.validators_to_go=0,this.after_validators=null,this.options=function(e){return e?"string"==typeof e?this._options[e]:t.extend(!0,this._options,e):this._options},!i||"object"!=typeof i){if(!a||"object"!=typeof a)return console.log("$.TdpPlugin constructor called without mandatory parameters");i=a,a={}}a&&"object"==typeof a||(a={}),this.options("logger")&&t(this.options("logger")).length?this._log=t(this.options("logger")):this._log=null,this.show=function(){return e.show(this.options("dialogShowDuration")),e},this.hide=function(){return e.hide(this.options("dialogCloseDuration")),e},this.getInput=function(t){if(!this._parameters.values[t])return console.warn('Unknown input "'+t+'"'),"";var a="radio"===this._parameters.values[t].type?":checked":"",i=e.find('input[name="'+t+'"]'+a+',textarea[name="'+t+'"],select[name="'+t+'"]').first();return i.length?i:""!==a&&(i=e.find('input[name="'+t+'"],textarea[name="'+t+'"],select[name="'+t+'"]').first(),i.length)?i:(console.warn('Element for input "'+t+'" does not exist'),"")},this.getValue=function(t){var e=this.getInput(t);return e&&("radio"!==e.attr("type")||e.prop("checked"))?e.val():""},this.setValue=function(t,a){if("radio"===this._parameters.values[t].type)return a?e.find('input[name="'+t+'"]').filter('[value="'+a+'"]').prop("checked",!0):e.find('input[name="'+t+'"]').prop("checked",!1);var i=this.getInput(t);return i.length?("select"===this._parameters.values[t].type&&i.prop("selectedIndex",0),this.getInput(t).val(a)):(console.warn('Element for input "'+t+'" does not exist'),!1)},this.showValidationMsg=function(t,e){var a=this._parameters.values[t];a.validation_msg_el&&(e&&a.validation_msg.html(e),this.options("validationMessageShow")(a.validation_msg_el))},this.hideValidationMsg=function(t){var e=this._parameters.values[t];e.validation_msg_el&&(this.options("validationMessageHide")(e.validation_msg_el),e.validation_msg.html(""))},this.showValidationOk=function(t){var e=this._parameters.values[t];e.validation_ok&&this.options("validationOkShow")(e.validation_ok)},this.hideValidationOk=function(t){var e=this._parameters.values[t];e.validation_ok&&this.options("validationOkHide")(e.validation_ok)},this.showValidationWorking=function(t){var e=this._parameters.values[t];e.validation_working&&l.options("validationWorkingShow")(e.validation_working)},this.hideValidationWorking=function(t){var e=this._parameters.values[t];e.validation_working&&l.options("validationWorkingHide")(e.validation_working)},this.reset=function(){var t=this;Object.keys(this._parameters.values).forEach(function(e){var a=t._parameters.values[e];"hidden"!==a.type&&(a.validated=null,a.old_value=null,t.setValue(e,a.value),t.hideValidationMsg(e),t.hideValidationOk(e),a.value&&t.options("prevalidation")&&t.validate(e))})},this.validate=function(e,a){if("string"==typeof e&&"hidden"===this._parameters.values[e].type)return this._parameters.values[e].validated=!0,!0;var i=e instanceof jQuery?e:"string"==typeof e?this.getInput(e):t(e);if(i.is("input,textarea,select")){var n=this;n.after_validators=null;var o=i.attr("name");if(o in n._parameters.values){var s=n.getValue(o),l=n._parameters.values[o];if(s===l.old_value)if(l.match){if(n.getValue(l.match)==s)return}else if(!l.revalidate)return;a?l.old_value=null:l.old_value=s;var r=[],d=!1,u=!1;if(a&&(u=!0),Number.isNaN(s)||void 0===s||null==s||""===s.trim())return n.hideValidationOk(o),l.empty?(l.validated=!0,!0):(n.showValidationMsg(o,n.options("errorMessageEmptyInput")),l.validated=!1,!1);if(!l.conditions||!l.conditions.length)return l.validated=!0,n.options("notEmptyAsValidated")&&n.showValidationOk(o),!0;l.conditions.some(function(e){if(a&&t.inArray(e.type,a)>-1)return!1;var i,v,p=!0;switch(l.type){case"tel":case"email":case"password":case"text":i=s.length,v=e.value;break;case"date":i=new Date(s),v=new Date(e.value);break;case"integer":i=parseInt(s,10),v=e.value;break;case"float":i=parseFloat(s,10),v=e.value;break;case"checkbox":case"radio":case"select":i=s,v=e.value;break;case"hidden":break;default:console.warn('Input "'+o+'" has unknown input type "'+l.type+'"')}switch(null!==n._log&&n._log.append("Evaluating condition '"+e.type+"("+i+", "+v+")'\n"),e.type){case"regular":var c=new RegExp(e.value);p=c.test(s);break;case"not":p=i!==v;break;case"notNaN":p=!Number.isNaN(i)&&void 0!==i;break;case"valid":p=i==s;break;case"min":p=!Number.isNaN(i)&&void 0!==i&&i>=v;break;case"max":p=!Number.isNaN(i)&&void 0!==i&&v>=i;break;case"match":p=s==n.getValue(e.value);break;case"date":case"age":var h,f=!1;if(t.isArray(e.value)?n.getValue(e.value[0])&&n.getValue(e.value[1])&&n.getValue(e.value[2])?h=new Date(n.getValue(e.value[0]),n.getValue(e.value[1])-1,n.getValue(e.value[2])):f=!0:h=new Date(s),f)u=!0,p=!0;else if("[object Date]"!==Object.prototype.toString.call(h)||isNaN(h.getTime()))p=!1;else if("age"===e.type){var m=+h;p=~~((Date.now()-m-864e5)/315576e5)>=e.value[3]}else if(h.getFullYear()==n.getValue(e.value[0])&&h.getMonth()==n.getValue(e.value[1])-1&&h.getDate()==n.getValue(e.value[2])){if(p=!0,t.isArray(e.value)){var g=l.validated;l.validated=1,e.value.some(function(t){o==t||n._parameters.values[t].validated||n.validate(t,a)}),l.validated=g}}else p=!1;break;case"validator":if(s==l.value&&l.prevalidated)p=!0;else{n.hideValidationMsg(o),n.hideValidationOk(o),n.showValidationWorking(o),d=!0,l.validated=0;t.ajax({url:e.value,type:"POST",data:JSON.stringify(n.options("validatorRequestProcessor")(s,e.params)),dataType:"json",timeout:5e3,cache:!1,success:function(t){var a=n.options("validatorResponseProcessor")(t),i=!1;i="string"==typeof a?n.options("validationMessageProcessor")([a]):a?e.message:!1,i?(l.validated=0,n.showValidationMsg(o,i)):(l.validated=1,n.showValidationOk(o),n.validators_to_go>0&&0===--n.validators_to_go&&null!==n.after_validators&&n.after_validators())},error:function(t){l.validated=0,p=n.options("validationMessageProcessor")([e.message]),n.showValidationMsg(o,p)},async:!0}).always(function(){n.hideValidationWorking(o)})}break;default:console.warn('Unknown condition type "'+e.type+'"')}return!p&&(r.push(e.message),e.last)?!0:!1}),u||d||(l.validated=0===r.length);var v=n.options("validationMessageProcessor")(r);return v?(n.showValidationMsg(o,v),n.hideValidationOk(o)):(n.hideValidationMsg(o),u||d||l.match&&!n._parameters.values[l.match].validated?n.hideValidationOk(o):n.showValidationOk(o)),!v}console.warn('Input "'+o+'" is not defined for validation')}else console.warn('Element "'+e+'" is not valid input')},Object.keys(this._parameters.values).forEach(function(a){var i=l._parameters.values[a];i.validated||(i.validated=null),i.old_value=null;var r=!1,d=!1,u=!1;i.conditions&&i.conditions.length&&i.conditions.some(function(t){return"match"===t.type?(r=t.value,void(d=!0)):"date"===t.type?void(d=!0):"validator"===t.type?void(u=!0):void 0}),i.match=r,i.revalidate=d,i.online_validator=u,e.find('input[name="'+a+'"],textarea[name="'+a+'"],select[name="'+a+'"]').each(function(){if(input_element=t(this),"select"===i.type&&(i.interval||i.values)&&(i.values&&i.values.some(function(t){var e=[];e="string"==typeof t?[t,t,!1]:[t[0],t.length>1?t[1]:t[0],t.length>2?!t[2]:!1];var a=s("option",t[1]).attr("value",t[0]);t[2]&&a.attr("disabled"),i.value==e[1]&&a.attr("selected"),input_element.append(a)}),i.interval)){var r=i.interval[0],d=i.interval[1],u=d>r?1:-1;i.interval.length>2&&(u*=i.interval[2]);var v;for(v=r;d*u>=v*u;v+=u)input_element.append(s("option",v).attr("value",v))}"radio"===i.type?(i.value&&input_element.filter('[value="'+i.value+'"]').prop("checked",!0),input_element.on("click",function(){l.validate(a)})):(i.value&&input_element.val(i.value),input_element.on("input",function(){l.validate(a,["validator","min","not","match"])}),input_element.on("change, blur",function(){l.validate(a)}));var p=input_element;"radio"===i.type&&(p=e.find('input[name="'+a+'"]').last(),p.next('label[for="'+p.attr("id")+'"]').length&&(p=p.next('label[for="'+p.attr("id")+'"]'))),e.find(o(l.options("validationMessageElement"),a)).length||e.find(o(l.options("validationOkElement"),a)).length||p.after(s(l.options("validationMessageElement"),"").attr("name",a).hide()).after(s(l.options("validationOkElement"),l.options("validationOkText")).attr("name",a).hide());var c=!1;i.conditions&&i.conditions.length&&i.conditions.some(function(t){return"validator"===t.type?void(c=!0):void 0}),c&&(e.find(o(l.options("validationWorkingElement"),a)).length||p.after(s(l.options("validationWorkingElement"),"").attr("name",a).hide()),i.validation_working=e.find(o(l.options("validationWorkingElement"),a)).first()),i.validation_msg=e.find(o(l.options("validationMessageElement"),a)).first(),i.validation_msg_el=e.find(n(l.options("validationMessageElement"))+'[name="'+a+'"]').first(),i.validation_ok=e.find(n(l.options("validationOkElement"))+'[name="'+a+'"]').first(),l.hideValidationOk(a),l.hideValidationMsg(a),l.hideValidationWorking(a),i.value&&l.options("prevalidation")&&l.validate(a)})}),this.revalidateAll=function(e,a){var i=null,o=0,s=this;return Object.keys(s._parameters.values).forEach(function(l){var r=s._parameters.values[l];if(s.validators_to_go=0,"hidden"!==r.type&&(!r.validated||r.revalidate)){var d=s.getInput(l);(!e||null===r.validated||r.revalidate)&&(r.online_validator&&s.validators_to_go++,s.validate(l,a)),r.validated||null===r.validated||(i=null===i?d.offset().top:Math.min(i,d.offset().top),setTimeout(function(){s.options("validationMessageFlash")(t(n(s.options("validationMessageElement"))+'[name="'+l+'"]').first())},s.options("validationMessageFlashDelay")*o++))}}),i?(t("html, body").animate({scrollTop:i},s.options("scrollToErrorDuration")),!1):!0},this.submitForm=function(t){return l.revalidateAll(!0)?null!==l.options("submitMethod")?(null!==t&&"object"==typeof t&&t.preventDefault(),l.options("submitMethod")(l)):!0:(null!==t&&"object"==typeof t&&t.preventDefault(),l.validators_to_go>0&&null!==l.options("submitMethod")&&(l.after_validators=function(){return l.options("submitMethod")(l)}),!1)},e.is("form")&&e.submit(function(t){return l.submitForm(t)?!0:!1}),e.find(this.options("submitElement")).on("click",function(t){return l.submitForm(t)?!0:!1})};t.fn.tdp=function(a){function i(){var e=t(this),a=e.data("TdpPlugin");d.push(a)}function n(t){var e=d[t];if(!e)return console.warn("$.TdpPlugin not instantiated yet"),console.info(this),void u.push(void 0);if("function"==typeof e[l]){var a=e[l].apply(e,r);u.push(a)}else console.warn("Method '"+l+"' not defined in $.TdpPlugin")}function o(){var a=t(this),i=new e(a,s,r);a.data("TdpPlugin",i)}var s,l="string"==typeof a?a:void 0,r=arguments.length>1?Array.prototype.slice.call(arguments,1)[0]:void 0,d=[],u=[];return l?(this.each(i),this.each(n),u.length>1?u:u[0]):(s="object"==typeof a?a:void 0,this.each(o))}}(jQuery);
